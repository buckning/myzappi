<!DOCTYPE html>
<html>
<head>
    <title th:text="${pageTitle}">Not Found</title>
    <link rel="icon" href="https://myzappi-site.s3.eu-west-1.amazonaws.com/myzappi-icon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="https://myzappi-site.s3.eu-west-1.amazonaws.com/myzappi-icon.ico"
          type="image/x-icon">
    <style>
        body {
            background-color: #077ed5;
            color: white;
            font-family: Arial, sans-serif;
        }

        .container {
            text-align: center;
            margin-top: 100px;
        }

        .logo {
            width: 120px;
            height: auto;
            margin: 0 auto;
        }

        .welcome-message {
            font-size: 24px;
            margin-top: 20px;
            padding-bottom: 15px;
        }

        .button {
            margin-top: 20px;
            background-color: lightgrey;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            color: black;
        }

        .paragraph {
            margin-top: 10px;
            font-size: 18px;
            padding-bottom: 15px;
        }

        .button:hover {
            background-color: darkgrey;
        }

        .youtube-video {
            margin-top: 50px;
            text-align: center;
            padding-bottom: 5px;
        }

        footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #333;
            padding: 20px;
            text-align: center;
        }

        footer a {
            color: white;
            text-decoration: none;
            margin-right: 10px;
        }

        form {
            max-width: 400px;
            margin: 0 auto;
            color: #333333;
            background-color: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .tariffForm {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin-bottom: 10px;
        }

        input[type="text"] {
            width: 380px;
            padding: 10px;
            padding-right: 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 10px; /* Added vertical spacing */
        }

        .tariffTable .tariffName {
            width: 100px;
            padding: 10px;
            padding-right: 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        input[type="number"] {
            width: 60px;
            padding: 10px;
            padding-right: 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 10px; /* Added vertical spacing */
        }

        input[type="password"] {
            width: 380px;
            padding: 10px;
            padding-right: 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 10px; /* Added vertical spacing */
        }

        button {
            background-color: #4CAF50;
            color: #fff;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .forgetMyDetailsButton {
            background-color: #ff6f6f;
            color: #fff;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .deleteButton {
            background-color: #ff6f6f;
            color: #fff;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .message {
            margin-top: 10px;
            padding: 5px;
            border-radius: 5px;
            max-width: 400px;
            margin: 0 auto;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .overlap {
            background-color: #ffcaca;
        }

    </style>
</head>
<body>
<div id="amazon-root"></div>
<script type="text/javascript">
    window.onAmazonLoginReady = function () {
        amazon.Login.setClientId('amzn1.application-oa2-client.d5625b3b0b334a388b07e0f70895ab84');
    };
    (function (d) {
        var a = d.createElement('script');
        a.type = 'text/javascript';
        a.async = true;
        a.id = 'amazon-login-sdk';
        a.src = 'https://assets.loginwithamazon.com/sdk/na/login1.js';
        d.getElementById('amazon-root').appendChild(a);
    })(document);

</script>
<div class="container">
    <img class="logo" src="https://myzappi-site.s3.eu-west-1.amazonaws.com/myzappi-icon.png" alt="Logo">
    <h1 class="welcome-message">Welcome to My Zappi (unofficial)</h1>
    <p class="paragraph">Control myenergi Zappi with Alexa.</p>
    <a href id="LoginWithAmazon" th:unless="${loggedIn}">
        <img border="0" alt="Login with Amazon"
             src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_156x32.png"
             width="156" height="32"/>
    </a>
</div>
<div class="container" th:if="${loggedIn && registered}" style="background-color: #2d84da; padding: 10px;">
    <div>
        Your Zappi device is registered on My Zappi. You can start using My Zappi on your Alexa.
    </div>
    <div>
        <p th:text="${existingSerialNumber}"></p>
        <button id="forgetMyDetailsButton" class="forgetMyDetailsButton">Delete Zappi</button>
    </div>
</div>

<div th:if="${loggedIn && registered}">
    <form id="tariffForm" class="tariffForm">
        <h1>Enter your tariffs</h1>
        <div>
            Submit your tariff details here for Alexa to tell you your energy costs.
            </br>
            <i>"Alexa, ask my charger for an energy cost for today"</i>
        </div>
        </br>
        <label for="currency">Currency:</label>
        <select id="currency" name="currency" required>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
        </select><br><br>

        <h2>Tariffs:</h2>

        <table id="tariffTable" class="tariffTable">
            <thead>
            <tr>
                <th>Name</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Import Cost per kWh</th>
                <th>Export Cost per kWh</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <!-- Tariff rows will be dynamically added here -->
            </tbody>
        </table>

        <button type="button" onclick="addTariffRow()" id="addTariffButton">Add Tariff</button>
        <br><br>

        <button type="submit">Submit</button>
    </form>
</div>
<script type="text/javascript">
    document.getElementById('LoginWithAmazon').onclick = function () {
        options = {}
        options.scope = 'profile';
        options.scope_data = {
            'profile': {'essential': false}
        };
        amazon.Login.authorize(options,
            'https://myzappiunofficial.com');
        return false;
    };
</script>

<div class="container" th:if="${loggedIn && !registered}">
    <p>
        Set up My Zappi by entering your myenergi details.
    </p>
</div>

<form id="loginCodeForm" th:if="${loggedIn && !registered}">

    <div>
        <label for="serialNumber" th:text="${serialNumber}">Substitute Serial Number:</label>
        <input type="text" id="serialNumber" name="serialNumber" autocomplete="off" required>
    </div>
    <div>
        <label for="apiKey" th:text="${apiKey}">Substitute Key:</label>
        <input type="password" id="apiKey" name="apiKey" autocomplete="off" required>
    </div>
    <div>
        <button type="button" id="submitBtn">Submit</button>
    </div>
</form>

<div id="messageContainer"></div>


<div class="container">
    <div class="container" th:if="${loggedIn}">
        <button id="logoutButton">Logout</button>
    </div>
    <iframe th:unless="${loggedIn}" width="560" height="315" src="https://www.youtube.com/embed/O4uwwfODdfs"
            frameborder="0"
            allowfullscreen></iframe>
    </br>
    <a href="https://alexa-skills.amazon.co.uk/apis/custom/skills/amzn1.ask.skill.6df2a131-f1f3-4b18-8edc-752a0e583512/launch">
        <img border="0" alt="Launch with Amazon"
             src="https://m.media-amazon.com/images/G/01/mobile-apps/dex/avs/docs/ux/branding/button1._TTH_.png"
             width="76" height="76"/>
    </a>
</div>

<footer>
    <a href="https://myzappi-site.s3.eu-west-1.amazonaws.com/termsOfService.html">Terms of Service</a>|
    <a href="https://myzappi-site.s3.eu-west-1.amazonaws.com/privacyStatement.html">Privacy Statement</a>
</footer>

<script th:inline="javascript">
    var forgetButton = document.getElementById("forgetMyDetailsButton");

    forgetButton.addEventListener("click", function (event) {
        var apiUrl = /*[[${registerUrl}]]*/ '';
        event.preventDefault(); // Prevent form submission

        forgetButton.disabled = true;

        fetch(apiUrl, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (response) {
                if (response.status === 204 || response.status === 200) {
                    location.reload();
                } else {
                    forgetButton.disabled = false;
                    showMessage("Something went wrong. Please try again later.", "error");
                }
            })
            .catch(function (error) {
                forgetButton.disabled = false;
                showMessage("Something is very wrong, please try again later", "error");
            });
    });
</script>

<script th:inline="javascript">
    // Move the logout button event listener here
    document.getElementById('logoutButton').addEventListener('click', function (event) {
        amazon.Login.logout();

        var logoutUrl = /*[[${logoutUrl}]]*/ '';
        var baseUrl = /*[[${apiUrl}]]*/ '';
        event.preventDefault(); // Prevent form submission

        fetch(logoutUrl, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (response) {
                window.location.href = baseUrl;
            })
            .catch(function (error) {
                window.location.href = baseUrl;
            });
    });
</script>

<script th:inline="javascript">
    var submitButton = document.getElementById("submitBtn");
    submitButton.addEventListener("click", function (event) {
        var apiUrl = /*[[${registerUrl}]]*/ '';
        event.preventDefault(); // Prevent form submission

        var apiKeyValue = document.getElementById("apiKey").value;
        var serialNumberValue = document.getElementById("serialNumber").value;

        submitButton.disabled = true;

        var requestBody = {
            "apiKey": apiKeyValue,
            "serialNumber": serialNumberValue
        };

        fetch(apiUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        })
            .then(function (response) {
                if (response.ok) {
                    document.getElementById("loginCodeForm").style.display = "none";
                    location.reload();
                    showMessage("My Zappi is now configured. You can start using it on your Alexa device.", "success");
                } else {
                    submitButton.disabled = false;
                    showMessage("Something went wrong. Please check you entered the correct serial number and API key.", "error");
                }
            })
            .catch(function (error) {
                submitButton.disabled = false;
                showMessage("Something is very wrong, please try again later", "error");
            });
    });

    function showMessage(message, type) {
        var messageContainer = document.getElementById("messageContainer");
        messageContainer.innerHTML = "<div class='message " + type + "'>" + message + "</div>";
    }


</script>

<script>
    var tariffCounter = 0;

    window.addEventListener("load", function() {
        updateAddTariffButton();
    });


    function addTariffRow() {
        if (tariffCounter >= 24) {
            return; // Maximum number of rows reached, exit the function
        }

        var tariffTable = document.getElementById("tariffTable");
        var tariffRow = document.createElement("tr");
        tariffRow.id = "tariffRow_" + tariffCounter;

        tariffRow.innerHTML = `
        <td>
          <input type="text" name="name" class="tariffName" required oninput="updateAddTariffButton()">
        </td>
        <td>
          <input type="number" name="startTime" min="0" max="23" required oninput="updateAddTariffButton()">
        </td>
        <td>
          <input type="number" name="endTime" min="1" max="24" required oninput="updateAddTariffButton()">
        </td>
        <td>
          <input type="number" step="0.0001" name="importCostPerKwh" min="0" required oninput="updateAddTariffButton()">
        </td>
        <td>
          <input type="number" step="0.0001" name="exportCostPerKwh" min="0" required oninput="updateAddTariffButton()">
        </td>
        <td>
          <button type="button" class="deleteButton" onclick="deleteTariffRow(${tariffCounter})">X</button>
        </td>`;

        tariffTable.querySelector("tbody").appendChild(tariffRow);
        tariffCounter++;

        updateAddTariffButton();
    }

    function deleteTariffRow(rowId) {
        var tariffRow = document.getElementById("tariffRow_" + rowId);
        tariffRow.remove();
        tariffCounter--;

        updateAddTariffButton();
    }

    function updateAddTariffButton() {
        var addTariffButton = document.getElementById("addTariffButton");
        addTariffButton.disabled = tariffCounter >= 24 || isAllHoursCovered();

        var submitButton = document.querySelector("button[type='submit']");
        submitButton.disabled = !isAllHoursCovered() || hasEmptyFields();

        highlightOverlappingRows();
    }

    function hasEmptyFields() {
        var rows = document.querySelectorAll("#tariffTable tbody tr");
        for (var i = 0; i < rows.length; i++) {
            var inputs = rows[i].querySelectorAll("input");
            for (var j = 0; j < inputs.length; j++) {
                if (inputs[j].value.trim() === "") {
                    return true;
                }
            }
        }
        return false;
    }

    function isAllHoursCovered() {
        var hoursCovered = [];

        var tariffRows = document.querySelectorAll("#tariffTable tbody tr");
        tariffRows.forEach(function(row) {
            var startTime = parseInt(row.querySelector("[name='startTime']").value);
            var endTime = parseInt(row.querySelector("[name='endTime']").value);

            for (var hour = startTime; hour < endTime; hour++) {
                if (!hoursCovered.includes(hour)) {
                    hoursCovered.push(hour);
                }
            }
        });

        return hoursCovered.length >= 24;
    }

    function highlightOverlappingRows() {
        var tariffTable = document.getElementById("tariffTable");
        var tariffRows = tariffTable.querySelectorAll("tbody tr");

        tariffRows.forEach(function(row) {
            row.classList.remove("overlap");
        });

        var tariffData = [];
        tariffRows.forEach(function(row) {
            var name = row.querySelector("[name='name']").value.trim();
            var startTime = parseInt(row.querySelector("[name='startTime']").value);
            var endTime = parseInt(row.querySelector("[name='endTime']").value);
            var importCostPerKwh = parseFloat(row.querySelector("[name='importCostPerKwh']").value);
            var exportCostPerKwh = parseFloat(row.querySelector("[name='exportCostPerKwh']").value);

            tariffData.push({
                name: name,
                startTime: startTime,
                endTime: endTime,
                importCostPerKwh: importCostPerKwh,
                exportCostPerKwh: exportCostPerKwh
            });
        });

        for (var i = 0; i < tariffData.length; i++) {
            var currentRow = tariffRows[i];
            for (var j = i + 1; j < tariffData.length; j++) {
                var otherRow = tariffRows[j];

                if (
                    (tariffData[i].startTime >= tariffData[j].startTime && tariffData[i].startTime < tariffData[j].endTime) ||
                    (tariffData[i].endTime > tariffData[j].startTime && tariffData[i].endTime <= tariffData[j].endTime) ||
                    (tariffData[i].startTime <= tariffData[j].startTime && tariffData[i].endTime >= tariffData[j].endTime)
                ) {
                    currentRow.classList.add("overlap");
                    otherRow.classList.add("overlap");
                }
            }
        }
    }

    document.getElementById("tariffForm").addEventListener("submit", function (event) {
        event.preventDefault();

        var formData = new FormData(this);

        var tariffs = [];
        var tariffRows = document.querySelectorAll("#tariffTable tbody tr");
        tariffRows.forEach(function(row) {
            var name = row.querySelector("[name='name']").value.trim();
            var startTime = parseInt(row.querySelector("[name='startTime']").value);
            var endTime = parseInt(row.querySelector("[name='endTime']").value);
            var importCostPerKwh = parseFloat(row.querySelector("[name='importCostPerKwh']").value);
            var exportCostPerKwh = parseFloat(row.querySelector("[name='exportCostPerKwh']").value);

            tariffs.push({
                name: name,
                startTime: startTime,
                endTime: endTime,
                importCostPerKwh: importCostPerKwh,
                exportCostPerKwh: exportCostPerKwh
            });
        });

        var payload = {
            currency: formData.get("currency"),
            tariffs: tariffs
        };


        fetch("https://myzappiunofficial.com/tariff", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
            .then(function (response) {
                if (response.ok) {
                    document.getElementById("tariffForm").style.display = "none";
                    showMessage("Your tariffs are configured. You can start using it on your Alexa device.", "success");
                } else {
                    showMessage("Something went wrong. Please check you entered the correct tariff information.", "error");
                }
            })
            .catch(function (error) {
                showMessage("Something is very wrong, please try again later", "error");
            });
        // Send the payload to the service
        console.log(payload);
        // Replace 'console.log(payload)' with your code to send the data to the service
    });
</script>
</body>
</html>
